# 🔍 تشخيص مشكلة الطباعة الشبكية في نظام CASNOS

## 📋 تحليل المشكلة

بعد فحص الكود بعناية، وجدت أن المشكلة في الطباعة الشبكية تكمن في **تسلسل الأحداث والتداخل بين الأنظمة**. إليك التشخيص الكامل:

### 🔄 التدفق الحالي للطباعة الشبكية:

1. **إنشاء التذكرة** (CustomerScreen أو API)
   - تُنشأ التذكرة بـ `print_status: 'pending'`
   - يتم إرسال إشعار إلى DisplayScreen عبر `print:pending-instant`

2. **استقبال الإشعار** (DisplayScreen)
   - يستقبل الإشعار عبر `onEvent('print:pending-instant')`
   - يحاول طباعة التذكرة فوراً

3. **الطباعة الفورية** (DisplayScreen)
   - يتم استدعاء `window.api.printTicket()`
   - يتم تحديث حالة الطباعة إلى `'printed'` أو `'print_failed'`

4. **النظام الاحتياطي** (DisplayScreen)
   - يوجد نظام احتياطي يتحقق من التذاكر المعلقة كل 30 ثانية
   - يطبع أي تذكرة لم تُطبع بعد

### 🚨 المشاكل المحتملة:

#### 1. **تضارب الأحداث**
```typescript
// الإشعارات المتضاربة
onEvent('print:pending-instant') // الطباعة الفورية
onEvent('queue:updated') // تحديث الطابور
onEvent('ticket:created') // إنشاء تذكرة جديدة
checkPendingTicketsInstantly() // النظام الاحتياطي
```

#### 2. **مشاكل الاستعلام عن قاعدة البيانات**
```typescript
// مشكلة في جلب اسم الخدمة
const serviceResponse = await window.api.getServiceById(ticket.service_id);
// إذا فشل هذا الاستعلام، قد تتوقف الطباعة
```

#### 3. **مشكلة في تسلسل الأحداث**
```typescript
// قد يتم تشغيل النظام الاحتياطي قبل اكتمال الطباعة الفورية
setTimeout(() => checkPendingTicketsInstantly(), 30000);
```

#### 4. **مشكلة في حالة الاتصال**
```typescript
if (!isConnected) return; // إذا انقطع الاتصال، تتوقف الطباعة
```

## 🛠️ خطة الحل (بدون تغييرات في الكود)

### المرحلة الأولى: التشخيص الفوري
1. **افتح ملف production-monitor.txt** للتحقق من وجود أخطاء PDF
2. **تأكد من اتصال DisplayScreen** بالخادم
3. **تحقق من حالة الطابعة** وإعداداتها
4. **راقب وحدة التحكم** في DisplayScreen لرسائل الأخطاء

### المرحلة الثانية: الفحص التفصيلي
1. **اختبر التذكرة المحلية أولاً** من CustomerScreen
2. **أنشئ تذكرة شبكية واحدة** وراقب السلوك
3. **تحقق من socket.io** في أدوات المطور
4. **راقب استهلاك الذاكرة** في DisplayScreen

### المرحلة الثالثة: إعدادات الشبكة
1. **تأكد من IP الخادم** في إعدادات DisplayScreen
2. **فحص firewall** والـ antivirus
3. **تأكد من port 3001** غير محجوب
4. **اختبر الاتصال** بـ `telnet server-ip 3001`

### المرحلة الرابعة: إعدادات الطباعة
1. **تأكد من وجود طابعة افتراضية** في النظام
2. **تحقق من Chromium/PDF** في مجلد الموارد
3. **اختبر SumatraPDF** يدوياً
4. **تأكد من صلاحيات الكتابة** في مجلد البيانات

## 🔧 حلول سريعة

### الحل الأول: إعادة تشغيل خدمة الطباعة
```bash
# في PowerShell كمسؤول
Stop-Service -Name "Spooler"
Start-Service -Name "Spooler"
```

### الحل الثاني: تنظيف البيانات المؤقتة
```bash
# حذف البيانات المؤقتة
rm -rf ./data/temp/*
rm -rf ./data/pdf/*
```

### الحل الثالث: فحص الاتصال
```bash
# اختبار الاتصال بالخادم
telnet localhost 3001
# أو
curl http://localhost:3001/api/health
```

### الحل الرابع: تسجيل مفصل
1. افتح **Developer Tools** في DisplayScreen
2. اذهب إلى **Console** وراقب الرسائل
3. اذهب إلى **Network** وراقب طلبات الـ API
4. اذهب إلى **Application** وتحقق من LocalStorage

## 📊 نقاط التحقق الأساسية

### ✅ قائمة الفحص السريع
- [ ] **الخادم يعمل** - فحص port 3001
- [ ] **DisplayScreen متصل** - فحص حالة الاتصال في الواجهة
- [ ] **الطابعة موجودة** - فحص إعدادات النظام
- [ ] **الملفات موجودة** - فحص مجلد resources
- [ ] **البيانات محدثة** - فحص قاعدة البيانات
- [ ] **الصلاحيات مناسبة** - فحص User permissions

### 🔍 علامات النجاح
- ظهور رسائل "✅ PDF generated successfully" في الكونسول
- ظهور رسائل "🖨️ Print request completed" في الكونسول
- تحديث حالة التذكرة إلى "printed" في قاعدة البيانات
- عدم وجود رسائل خطأ في production-monitor.txt

### 🚨 علامات الفشل
- رسائل "❌ PDF generation failed" في الكونسول
- رسائل "PRINT_FAILED" في الكونسول
- عدم تحديث حالة التذكرة في قاعدة البيانات
- انقطاع الاتصال بالخادم بشكل متكرر

## 🎯 الخطوات التالية

1. **ابدأ بالتشخيص الفوري** - افحص الملفات والاتصالات
2. **اختبر خطوة بخطوة** - تذكرة واحدة في كل مرة
3. **راقب الأخطاء** - استخدم أدوات التطوير
4. **تأكد من البيئة** - إعدادات النظام والشبكة
5. **اطلب المساعدة** - إذا استمرت المشكلة

## 💡 نصائح إضافية

- **استخدم نافذة منفصلة** لـ DisplayScreen للحصول على Developer Tools
- **اختبر في وضع المطور** أولاً قبل Production
- **احتفظ بملفات السجل** لتتبع المشاكل
- **راقب استهلاك الموارد** خاصة الذاكرة والشبكة

هذا التشخيص شامل لمشكلة الطباعة الشبكية. ابدأ بالخطوات الأساسية وتدرج نحو التشخيص المتقدم.
