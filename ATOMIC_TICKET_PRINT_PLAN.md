# ุฎุทุฉ ููุทู "ูุง ุทุจุงุนุฉุ ูุง ุชุฐูุฑุฉ" ุงูุฐุฑู
## Atomic "No Print, No Ticket" Logic Plan

### ๐ฏ ุงููุฏู ุงูุฑุฆูุณู
ุถูุงู ุฅูุดุงุก ุงูุชุฐูุฑุฉ **ููุท** ุนูุฏ ูุฌุงุญ ุงูุทุจุงุนุฉ - ุชุทุจูู ููุทู ุฐุฑู ูุถูุงู ุนุฏู ุฅูุดุงุก ุชุฐุงูุฑ ุจุฏูู ุทุจุงุนุฉ.

### ๐ ุงูุชุญููู ุงูุญุงูู ูููุธุงู

#### 1. ุชุฏูู ุงูุนูู ุงูุญุงูู:
```
CustomerScreen โ ุฅูุดุงุก ุชุฐูุฑุฉ โ ูุญุงููุฉ ุทุจุงุนุฉ โ ุชุญุฏูุซ ุญุงูุฉ ุงูุทุจุงุนุฉ
```

#### 2. ุงููุดููุฉ ุงูุญุงููุฉ:
- ุงูุชุฐูุฑุฉ ุชููุดุฃ ุฃููุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุฅุฐุง ูุดูุช ุงูุทุจุงุนุฉุ ุชุจูู ุงูุชุฐูุฑุฉ ููุฌูุฏุฉ ูุน ุญุงูุฉ `print_failed`
- ูุฐุง ูุฎู ุจูุจุฏุฃ "ูุง ุทุจุงุนุฉุ ูุง ุชุฐูุฑุฉ"

### ๐ ุงูููุทู ุงูุฐุฑู ุงูุฌุฏูุฏ

#### ุงูุฎูุงุฑ ุงูุฃูู: ููุทู ุงูุชุฑุงุฌุน (Rollback Logic)
```typescript
// 1. ุฅูุดุงุก ุชุฐูุฑุฉ ูุคูุชุฉ
const tempTicket = createTempTicket(serviceId, printType)

// 2. ูุญุงููุฉ ุงูุทุจุงุนุฉ
const printResult = await attemptPrint(tempTicket)

// 3. ุชุฃููุฏ ุฃู ุฅูุบุงุก ุงูุชุฐูุฑุฉ
if (printResult.success) {
  const finalTicket = confirmTicket(tempTicket)
  return { success: true, ticket: finalTicket }
} else {
  rollbackTicket(tempTicket.id)
  return { success: false, error: 'Print failed - no ticket created' }
}
```

#### ุงูุฎูุงุฑ ุงูุซุงูู: ููุทู ุงูุทุจุงุนุฉ ุฃููุงู (Print-First Logic)
```typescript
// 1. ุฅูุดุงุก PDF ูุคูุช
const pdfPath = await generateTicketPDF(ticketData)

// 2. ูุญุงููุฉ ุงูุทุจุงุนุฉ
const printResult = await printPDF(pdfPath, printerName)

// 3. ุฅูุดุงุก ุงูุชุฐูุฑุฉ ููุท ุนูุฏ ูุฌุงุญ ุงูุทุจุงุนุฉ
if (printResult.success) {
  const ticket = createTicketInDatabase(serviceId, printType)
  return { success: true, ticket }
} else {
  return { success: false, error: 'Print failed - no ticket created' }
}
```

### ๐๏ธ ุงูุชุทุจูู ุงูููุตู ุจู

#### ุงูุงุณุชุฑุงุชูุฌูุฉ: Print-First ูุน Transaction Safety

```typescript
export class AtomicTicketPrintManager {
  async createTicketWithAtomicPrint(
    serviceId: number,
    printType: 'local' | 'network',
    printerName: string
  ): Promise<AtomicTicketResult> {

    // 1. ุฅูุดุงุก ุจูุงูุงุช ุงูุชุฐูุฑุฉ ุฏูู ุญูุธูุง
    const ticketData = this.generateTicketData(serviceId)

    // 2. ุฅูุดุงุก PDF ูุคูุช
    const pdfPath = await this.generateTempPDF(ticketData)
    if (!pdfPath) {
      return { success: false, error: 'PDF generation failed' }
    }

    // 3. ูุญุงููุฉ ุงูุทุจุงุนุฉ
    const printResult = await this.attemptPrint(pdfPath, printerName)

    // 4. ุฅูุดุงุก ุงูุชุฐูุฑุฉ ููุท ุนูุฏ ูุฌุงุญ ุงูุทุจุงุนุฉ
    if (printResult.success) {
      const ticket = this.saveTicketToDatabase(serviceId, printType, 'printed')

      // 5. ุชูุธูู ุงูููู ุงููุคูุช
      this.cleanupTempFile(pdfPath)

      return {
        success: true,
        ticket,
        message: 'Ticket created and printed successfully'
      }
    } else {
      // 6. ุชูุธูู ุงูููู ุงููุคูุช ุนูุฏ ูุดู ุงูุทุจุงุนุฉ
      this.cleanupTempFile(pdfPath)

      return {
        success: false,
        error: `Print failed: ${printResult.error}`
      }
    }
  }
}
```

### ๐ ููุงุท ุงูุชุทุจูู

#### 1. ูู CustomerScreen:
- ุงุณุชุจุฏุงู `createTicket()` ุจู `createTicketWithAtomicPrint()`
- ุฅุฒุงูุฉ ููุทู `updatePrintStatus()` ุงููููุตู

#### 2. ูู DisplayScreen:
- ุชุทุจูู ููุณ ุงูููุทู ููุทุจุงุนุฉ ุงูุดุจููุฉ
- ุถูุงู ุนุฏู ุฅูุดุงุก ุชุฐุงูุฑ ููุทุจุงุนุฉ ุงููุงุดูุฉ

#### 3. ูู SmartPrintManager:
- ุฏูุฌ ููุทู ุงูุทุจุงุนุฉ ุงูุฐุฑู
- ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

### ๐ ุถูุงูุงุช ุงูุฃูุงู

#### 1. ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:
```typescript
try {
  // ูุญุงููุฉ ุงูุทุจุงุนุฉ
  const result = await atomicPrintManager.createTicketWithAtomicPrint(...)

  if (result.success) {
    // ุนุฑุถ ุงูุชุฐูุฑุฉ ูููุณุชุฎุฏู
    displayTicket(result.ticket)
  } else {
    // ุนุฑุถ ุฑุณุงูุฉ ุงูุฎุทุฃ
    showError(result.error)
  }
} catch (error) {
  // ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุงููุธุงููุฉ
  showSystemError('System error occurred')
}
```

#### 2. ุงูุชูุธูู ุงูุขูู:
- ุญุฐู ูููุงุช PDF ุงููุคูุชุฉ
- ุชูุธูู ุงูุฐุงูุฑุฉ ุงููุคูุชุฉ
- ุชุณุฌูู ุงูุฃุญุฏุงุซ ูููุฑุงุฌุนุฉ

### ๐๏ธ ุฅุนุฏุงุฏุงุช ุงูุชุดุบูู

#### ูุชุบูุฑุงุช ุงูุจูุฆุฉ:
```typescript
// ุฅุนุฏุงุฏุงุช ุงูุทุจุงุนุฉ ุงูุฐุฑูุฉ
ATOMIC_PRINT_ENABLED=true
TEMP_PDF_CLEANUP_DELAY=5000  // 5 ุซูุงู
PRINT_TIMEOUT=30000          // 30 ุซุงููุฉ
MAX_PRINT_RETRIES=3          // 3 ูุญุงููุงุช
```

### ๐ ูุฑุงูุจุฉ ุงูุฃุฏุงุก

#### ูุคุดุฑุงุช ุงูุฃุฏุงุก:
- ูุนุฏู ูุฌุงุญ ุงูุทุจุงุนุฉ ุงูุฐุฑูุฉ
- ุฃููุงุช ุงุณุชุฌุงุจุฉ ุงูุทุจุงุนุฉ
- ุนุฏุฏ ุงูุชุฐุงูุฑ ุงููููุดุฃุฉ vs ุงููุทุจูุนุฉ
- ูุนุฏู ุงูุฃุฎุทุงุก ูุงูุชุฑุงุฌุน

### ๐งช ุงุฎุชุจุงุฑ ุงููุธุงู

#### ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ:
1. **ูุฌุงุญ ุงูุทุจุงุนุฉ ุงููุญููุฉ**: ุงูุชุฐูุฑุฉ ุชููุดุฃ ูุชูุทุจุน
2. **ูุดู ุงูุทุจุงุนุฉ ุงููุญููุฉ**: ูุง ุชููุดุฃ ุชุฐูุฑุฉ
3. **ูุฌุงุญ ุงูุทุจุงุนุฉ ุงูุดุจููุฉ**: ุงูุชุฐูุฑุฉ ุชููุดุฃ ูุชูุทุจุน
4. **ูุดู ุงูุทุจุงุนุฉ ุงูุดุจููุฉ**: ูุง ุชููุดุฃ ุชุฐูุฑุฉ
5. **ุงููุทุงุน ุงูุงุชุตุงู**: ูุนุงูุฌุฉ ุขููุฉ ููุฃุฎุทุงุก

### ๐ ุฎุทุฉ ุงูุชุทุจูู

#### ุงููุฑุญูุฉ 1: ุฅูุดุงุก AtomicTicketPrintManager
- ุฅูุดุงุก ุงูููุงุณ ุงูุฌุฏูุฏ
- ุชุทุจูู ุงูููุทู ุงูุฐุฑู
- ุฅุถุงูุฉ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

#### ุงููุฑุญูุฉ 2: ุชุญุฏูุซ CustomerScreen
- ุฏูุฌ ุงูููุทู ุงูุฐุฑู
- ุฅุฒุงูุฉ ุงูููุทู ุงููุฏูู
- ุงุฎุชุจุงุฑ ุงููุธุงุฆู

#### ุงููุฑุญูุฉ 3: ุชุญุฏูุซ DisplayScreen
- ุชุทุจูู ุงูููุทู ุงูุฐุฑู ููุทุจุงุนุฉ ุงูุดุจููุฉ
- ุถูุงู ุงูุชูุงูู ูุน ุงููุธุงู ุงูุญุงูู

#### ุงููุฑุญูุฉ 4: ุงูุชุญุณูู ูุงููุฑุงูุจุฉ
- ุฅุถุงูุฉ ูุคุดุฑุงุช ุงูุฃุฏุงุก
- ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
- ุฅุถุงูุฉ ุชุณุฌูู ููุตู

### โ ุงูููุงุฆุฏ ุงููุชููุนุฉ

1. **ุถูุงู ุงูุชุทุงุจู**: ูู ุชุฐูุฑุฉ ูููุดุฃุฉ = ุชุฐูุฑุฉ ูุทุจูุนุฉ
2. **ุชุญุณูู ุงูุฃุฏุงุก**: ุชูููู ุนุฏุฏ ุงูุนูููุงุช ุงููุนููุฉ
3. **ุฃูุงู ุงูุจูุงูุงุช**: ุนุฏู ูุฌูุฏ ุชุฐุงูุฑ ูุชููุฉ
4. **ุณูููุฉ ุงูุตูุงูุฉ**: ููุทู ูุงุถุญ ูููุญุฏ
5. **ูุฑุงูุจุฉ ุฃูุถู**: ุชุชุจุน ุฏููู ูุญุงูุฉ ุงููุธุงู

### ๐จ ุงูุชุญุฏูุงุช ูุงูุญููู

#### ุงูุชุญุฏู 1: ุงูุทุจุงุนุฉ ุงูุดุจููุฉ ุงูุจุทูุฆุฉ
**ุงูุญู**: ุฒูุงุฏุฉ timeout ูุฅุถุงูุฉ ูุคุดุฑ ุชุญููู

#### ุงูุชุญุฏู 2: ูุดู ุงูุทุจุงุนุฉ ุงููุชูุฑุฑ
**ุงูุญู**: ุขููุฉ ุฅุนุงุฏุฉ ุงููุญุงููุฉ ูุน ุชุฃุฎูุฑ ุชุฏุฑูุฌู

#### ุงูุชุญุฏู 3: ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ
**ุงูุญู**: ุนูููุฉ ุชูุธูู ุขููุฉ ูุน ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

---

## ๐ ุงูุฎูุงุตุฉ

ูุฐุง ุงูููุทู ุงูุฐุฑู ุณูุถูู ุชุทุจูู ูุจุฏุฃ "ูุง ุทุจุงุนุฉุ ูุง ุชุฐูุฑุฉ" ุจุดูู ููุซููุ ููุง ูุญุณู ูู ุฏูุฉ ุงููุธุงู ููููู ูู ุงููุดุงูู ุงูุชุดุบูููุฉ.

ุงูุชุทุจูู ุณูููู ุชุฏุฑูุฌูุงู ููุฏุฑูุณุงู ูุถูุงู ุงุณุชูุฑุงุฑ ุงููุธุงู ุงูุญุงูู ุฃุซูุงุก ุงูุงูุชูุงู.
